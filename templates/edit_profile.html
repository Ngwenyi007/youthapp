{% extends "base.html" %}
{% block content %}
<div class="edit-profile-container">
    <div class="page-header">
        <h1>‚úèÔ∏è Edit Profile</h1>
        <a href="/profile/{{ user.username }}" class="btn btn-secondary">‚Üê Back to Profile</a>
    </div>

    <form method="POST" enctype="multipart/form-data" class="profile-form">
        <div class="form-sections">
            <!-- Profile Picture Section -->
            <div class="form-section">
                <h3>üì∏ Profile Picture</h3>
                <div class="profile-picture-section">
                    <div class="current-picture">
                        {% if user.profile_picture %}
                        <img src="/uploads/profiles/{{ user.profile_picture }}" alt="Current Profile Picture" id="currentPicture">
                        {% else %}
                        <div class="avatar-placeholder" id="currentPicture">{{ user.full_name[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="picture-upload">
                        <label for="profile_picture" class="upload-btn">
                            üì§ Change Picture
                        </label>
                        <input type="file" id="profile_picture" name="profile_picture" 
                               accept="image/*" style="display: none;">
                        <small class="hint">Supported: JPG, PNG, GIF (Max: 5MB)</small>
                        <div id="imagePreview" style="display: none;">
                            <img id="previewImg" style="max-width: 200px; border-radius: 10px; margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="form-section">
                <h3>üë§ Personal Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="full_name">Full Name *</label>
                        <input type="text" id="full_name" name="full_name" 
                               value="{{ user.full_name }}" required maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" 
                               value="{{ user.age }}" min="13" max="100" readonly>
                        <small class="readonly-note">Age cannot be changed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" 
                               value="{{ user.email or '' }}" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" 
                               value="{{ user.phone or '' }}" maxlength="20">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="bio">Bio / About Me</label>
                    <textarea id="bio" name="bio" rows="4" maxlength="500" 
                              placeholder="Tell others about yourself...">{{ user.bio or '' }}</textarea>
                    <div class="char-count">
                        <span id="bioCount">{{ (user.bio or '')|length }}</span>/500 characters
                    </div>
                </div>
            </div>

            <!-- Organization Information (Read-only) -->
            <div class="form-section">
                <h3>‚õ™ Organization Details</h3>
                <div class="readonly-info">
                    <p class="readonly-notice">
                        ‚ÑπÔ∏è Organization details cannot be changed. Contact your chairman if corrections are needed.
                    </p>
                    <div class="form-grid">
                        <div class="form-group readonly">
                            <label>Rank</label>
                            <input type="text" value="{{ user.rank }}" readonly>
                        </div>
                        
                        <div class="form-group readonly">
                            <label>Local Church</label>
                            <input type="text" value="{{ user.local_church }}" readonly>
                        </div>
                        
                        <div class="form-group readonly">
                            <label>Parish</label>
                            <input type="text" value="{{ user.parish }}" readonly>
                        </div>
                        
                        <div class="form-group readonly">
                            <label>Denary</label>
                            <input type="text" value="{{ user.denary }}" readonly>
                        </div>
                        
                        <div class="form-group readonly">
                            <label>Diocese</label>
                            <input type="text" value="{{ user.diocese }}" readonly>
                        </div>
                        
                        <div class="form-group readonly">
                            <label>Username</label>
                            <input type="text" value="{{ user.username }}" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="form-section">
                <h3>üîî Notification Settings</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label for="email_notifications">Email Notifications</label>
                            <small>Receive notifications via email</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="email_notifications" name="email_notifications"
                                   {% if user.settings.email_notifications %}checked{% endif %}>
                            <span class="slider"></span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label for="push_notifications">Push Notifications</label>
                            <small>Receive real-time notifications in browser</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="push_notifications" name="push_notifications"
                                   {% if user.settings.push_notifications %}checked{% endif %}>
                            <span class="slider"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="form-section">
                <h3>üîí Privacy Settings</h3>
                <div class="form-group">
                    <label for="privacy_level">Profile Visibility</label>
                    <select id="privacy_level" name="privacy_level">
                        <option value="public" {% if user.settings.privacy_level == 'public' %}selected{% endif %}>
                            üåç Public - Visible to all members
                        </option>
                        <option value="friends" {% if user.settings.privacy_level == 'friends' %}selected{% endif %}>
                            üë• Organization Only - Visible to members in your organization
                        </option>
                        <option value="private" {% if user.settings.privacy_level == 'private' %}selected{% endif %}>
                            üîí Private - Visible only to leaders
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="button" onclick="history.back()" class="btn btn-secondary">Cancel</button>
            <button type="reset" class="btn btn-outline">Reset Changes</button>
            <button type="submit" class="btn btn-primary">üíæ Save Profile</button>
        </div>
    </form>
</div>

<script>
// Image preview functionality
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        e.target.value = '';
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        e.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        previewImg.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
});

// Bio character counter
document.getElementById('bio').addEventListener('input', function() {
    const charCount = this.value.length;
    const counter = document.getElementById('bioCount');
    counter.textContent = charCount;
    
    if (charCount > 450) {
        counter.style.color = '#dc3545';
    } else if (charCount > 400) {
        counter.style.color = '#ffc107';
    } else {
        counter.style.color = '#28a745';
    }
});

// Form validation
document.querySelector('.profile-form').addEventListener('submit', function(e) {
    const fullName = document.getElementById('full_name').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!fullName) {
        e.preventDefault();
        alert('Full name is required');
        document.getElementById('full_name').focus();
        return;
    }
    
    if (email && !isValidEmail(email)) {
        e.preventDefault();
        alert('Please enter a valid email address');
        document.getElementById('email').focus();
        return;
    }
});

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Auto-save draft (store in localStorage)
function saveDraft() {
    const formData = {
        full_name: document.getElementById('full_name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        bio: document.getElementById('bio').value,
        email_notifications: document.getElementById('email_notifications').checked,
        push_notifications: document.getElementById('push_notifications').checked,
        privacy_level: document.getElementById('privacy_level').value
    };
    localStorage.setItem('profile_draft', JSON.stringify(formData));
}

// Load draft
function loadDraft() {
    const draft = localStorage.getItem('profile_draft');
    if (draft) {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = data[key];
                } else {
                    element.value = data[key];
                }
            }
        });
    }
}

// Save draft periodically
setInterval(saveDraft, 30000); // Every 30 seconds

// Clear draft on successful submit
document.querySelector('.profile-form').addEventListener('submit', function() {
    localStorage.removeItem('profile_draft');
});

// Confirm before leaving with unsaved changes
let hasChanges = false;
document.querySelectorAll('input, textarea, select').forEach(element => {
    element.addEventListener('change', () => {
        hasChanges = true;
    });
});

window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>

<style>
.edit-profile-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    margin: 0;
    color: #333;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-outline {
    background: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
}

.btn-outline:hover {
    background: #6c757d;
    color: white;
}

.profile-form {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
}

.form-sections {
    padding: 30px;
}

.form-section {
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.form-section h3 {
    margin: 0 0 25px 0;
    color: #333;
    font-size: 1.3em;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.profile-picture-section {
    display: flex;
    gap: 30px;
    align-items: center;
}

.current-picture {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid #007bff;
    flex-shrink: 0;
}

.current-picture img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5em;
    font-weight: bold;
}

.picture-upload {
    flex: 1;
}

.upload-btn {
    display: inline-block;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: bold;
}

.upload-btn:hover {
    background: #1e7e34;
}

.hint {
    display: block;
    margin-top: 8px;
    color: #666;
    font-size: 0.9em;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
}

.form-group input,
.form-group textarea,
.form-group select {
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.form-group.readonly input {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.readonly-note {
    color: #666;
    font-size: 0.8em;
    margin-top: 5px;
}

.readonly-info {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #ffc107;
}

.readonly-notice {
    margin: 0 0 20px 0;
    color: #856404;
    font-weight: bold;
}

.char-count {
    text-align: right;
    margin-top: 5px;
    font-size: 0.9em;
    color: #666;
}

.settings-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.setting-info label {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.setting-info small {
    color: #666;
    font-size: 0.9em;
}

.toggle-switch {
    position: relative;
    width: 60px;
    height: 30px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 30px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #007bff;
}

input:checked + .slider:before {
    transform: translateX(30px);
}

.form-actions {
    padding: 20px 30px;
    background: #f8f9fa;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

/* Validation styles */
.form-group input:invalid {
    border-color: #dc3545;
}

.form-group input:valid {
    border-color: #28a745;
}

.error-message {
    color: #dc3545;
    font-size: 0.9em;
    margin-top: 5px;
}

.success-message {
    color: #28a745;
    font-size: 0.9em;
    margin-top: 5px;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .edit-profile-container {
        padding: 15px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .profile-picture-section {
        flex-direction: column;
        text-align: center;
    }
    
    .page-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .setting-item {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .form-sections {
        padding: 20px;
    }
}

/* Animation for form sections */
.form-section {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Loading state */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.form-group.loading input {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 2s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
{% endblock %}